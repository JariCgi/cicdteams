name: Dummy CI/CD (multi-item RSS under /feed/feed.xml)

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'data/feed_items.json'   # estää historiacommitin käynnistämästä uutta ajoa
  workflow_dispatch:

permissions:
  contents: write      # commitoidaan historiaa repoosi
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REPO: ${{ github.repository }}                  # owner/repo
      OWNER: ${{ github.repository_owner }}
      SHA: ${{ github.sha }}
      COMMIT_MSG: ${{ github.event.head_commit.message || 'Automated deploy' }}
      ACTOR: ${{ github.actor }}
      COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
      KEEP_COUNT: "10"                                # montako itemiä pidetään feedissä

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install jq (for JSON ops)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # 1) Päivitä historia (data/feed_items.json)
      - name: Update feed history (prepend new item, keep last N)
        shell: bash
        run: |
          set -euo pipefail

          REPO_NAME="${REPO#*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO_NAME}/"
          pub_date="$(date -u +"%a, %d %b %Y %H:%M:%S GMT")"
          guid="${SHA}-$(date +%s)"

          # XML-escape commit-viesti (title)
          raw_msg="${COMMIT_MSG:-Automated deploy}"
          msg_escaped=$(printf '%s' "$raw_msg" \
            | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g' -e "s/\"/\&quot;/g" -e "s/'/\&apos;/g")

          mkdir -p data

          # Jos historiaa ei ole, luodaan tyhjä lista
          if [ ! -f data/feed_items.json ]; then
            echo '[]' > data/feed_items.json
          fi

          echo "Existing items (before):"
          cat data/feed_items.json || true

          # Uusi item JSON:na
          NEW_ITEM=$(jq -n \
            --arg title "$msg_escaped" \
            --arg description "Deploy by ${ACTOR}" \
            --arg pubDate "$pub_date" \
            --arg guid "$guid" \
            --arg link "$BASE_URL" \
            '{title: $title, description: $description, pubDate: $pubDate, guid: $guid, link: $link}')

          # Prepend uusi, poista duplikaatit guidin mukaan, trimmaa N
          UPDATED=$(jq --argjson item "$NEW_ITEM" --argjson keep ${KEEP_COUNT} '
            [ $item ] + .           # lisää alkuun
            | unique_by(.guid)      # uniikit guidit
            | .[:$keep]             # pidä vain N ensimmäistä
          ' data/feed_items.json)

          printf '%s\n' "$UPDATED" > data/feed_items.json

          echo "Updated items (after):"
          cat data/feed_items.json

          # Commit & push vain jos muuttui
          if ! git diff --quiet -- data/feed_items.json; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/feed_items.json
            git commit -m "chore: update feed history (add ${guid})"
            # push suoraan nykyiseen branchiin
            git push origin HEAD
          else
            echo "No changes to feed history."
          fi

