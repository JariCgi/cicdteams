name: Dummy CI/CD (multi-item RSS under /feed/feed.xml)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write      # <-- tarvitaan, jotta voimme commitoida history-tiedoston
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REPO: ${{ github.repository }}                  # owner/repo
      OWNER: ${{ github.repository_owner }}
      SHA: ${{ github.sha }}
      COMMIT_MSG: ${{ github.event.head_commit.message || 'Automated deploy' }}
      ACTOR: ${{ github.actor }}
      COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
      KEEP_COUNT: "10"                                # montako itemiä pidetään feedissä

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Päivitä historia (data/feed_items.json)
      - name: Update feed history (prepend new item, keep last N)
        shell: bash
        run: |
          set -euo pipefail

          REPO_NAME="${REPO#*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO_NAME}/"
          pub_date="$(date -u +"%a, %d %b %Y %H:%M:%S GMT")"
          guid="${SHA}-$(date +%s)"

          # XML-escape commit-viestiä varten (title)
          raw_msg="${COMMIT_MSG:-Automated deploy}"
          msg_escaped=$(printf '%s' "$raw_msg" \
            | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g' -e "s/\"/\&quot;/g" -e "s/'/\&apos;/g")

          mkdir -p data

          # Jos historiaa ei ole, luodaan tyhjä lista
          if [ ! -f data/feed_items.json ]; then
            echo '[]' > data/feed_items.json
          fi

          echo "Existing items (before):"
          cat data/feed_items.json

          # Rakennetaan uusi item JSON-objektina
          NEW_ITEM=$(jq -n \
            --arg title "$msg_escaped" \
            --arg description "Deploy by ${ACTOR}" \
            --arg pubDate "$pub_date" \
            --arg guid "$guid" \
            --arg link "$BASE_URL" \
            '{title: $title, description: $description, pubDate: $pubDate, guid: $guid, link: $link}')

          # Prependataan uusi item, poistetaan duplikaatit guidin perusteella ja trimmi viimeiset KEEP_COUNT
          UPDATED=$(jq --argjson item "$NEW_ITEM" --argjson keep ${KEEP_COUNT} '
            [ $item ] + .                                  # lisää alkuun
            | unique_by(.guid)                             # varmistetaan uniikkius guidin perusteella
            | .[:$keep]                                    # pidä vain N ensimmäistä
          ' data/feed_items.json)

          printf '%s\n' "$UPDATED" > data/feed_items.json

          echo "Updated items (after):"
          cat data/feed_items.json

          # Konfiguroi git ja commitoi muutos vain jos muuttui
          if ! git diff --quiet -- data/feed_items.json; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/feed_items.json
            git commit -m "chore: update feed history (add ${guid})"
            git push
          else
            echo "No changes to feed history."
          fi

      # 2) Rakenna sivu (index.html)
      - name: Build site (index.html)
        run: |
          set -euo pipefail
          REPO_NAME="${REPO#*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO_NAME}/"
          mkdir -p dist
          cat > dist/index.html <<HTML
          <!doctype html>
          <html lang="fi">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width,initial-scale=1" />
              <title>CI/CD demo – ${REPO_NAME}</title>
              <style>
                body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:2rem;line-height:1.5}
                code{background:#f4f4f4;padding:.2rem .4rem;border-radius:.25rem}
                a{color:#0366d6;text-decoration:none}
                a:hover{text-decoration:underline}
              </style>
            </head>
            <body>
              <h1>CI/CD demo</h1>
              <p><strong>Päivitetty:</strong> $(date -u)</p>
              <p><strong>Commit:</strong> <a href="${COMMIT_URL}"><code>${SHA}</code></a></p>
              <p><strong>Tekijä:</strong> ${ACTOR}</p>
              <p>Base URL: <a href="${BASE_URL}">${BASE_URL}</a></p>
              <p>RSS: <a href="${BASE_URL}feed/feed.xml">${BASE_URL}feed/feed.xml</a></p>
            </body>
          </html>
          HTML

      # 3) Generoi feed.xml KAIKISTA historiasta
      - name: Generate RSS (/feed/feed.xml) from history
        run: |
          set -euo pipefail
          REPO_NAME="${REPO#*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO_NAME}/"

          mkdir -p dist/feed

          # lastBuildDate = tuorein itemin pubDate, tai nyt
          if jq -e 'length > 0' data/feed_items.json >/dev/null 2>&1; then
            lastBuildDate=$(jq -r '.[0].pubDate' data/feed_items.json)
          else
            lastBuildDate="$(date -u +"%a, %d %b %Y %H:%M:%S GMT")"
          fi

          {
            echo '<?xml version="1.0" encoding="UTF-8"?>'
            echo '<rss version="2.0">'
            echo '  <channel>'
            echo "    <title>${OWNER}/${REPO_NAME} – CI/CD Demo Feed</title>"
            echo "    <link>${BASE_URL}</link>"
            echo '    <description>Automated RSS from GitHub Actions deploys</description>'
            echo "    <lastBuildDate>${lastBuildDate}</lastBuildDate>"
            # Tulosta kaikki itemit järjestyksessä
            jq -r '.[] | @base64' data/feed_items.json | while read -r line; do
              obj=$(echo "$line" | base64 --decode)
              title=$(echo "$obj" | jq -r '.title')
              desc=$(echo "$obj" | jq -r '.description')
              pd=$(echo "$obj" | jq -r '.pubDate')
              guid=$(echo "$obj" | jq -r '.guid')
              link=$(echo "$obj" | jq -r '.link')
              cat <<ITEM
                <item>
                  <title>${title}</title>
                  <description>${desc}</description>
                  <pubDate>${pd}</pubDate>
                  <guid isPermaLink="false">${guid}</guid>
                  <link>${link}</link>
                </item>
ITEM
            done
            echo '  </channel>'
            echo '</rss>'
          } > dist/feed/feed.xml

      - name: Verify feed exists and list files
        run: |
          set -euo pipefail
          echo "Listing dist/ content:"
          find dist -maxdepth 3 -type f -print | sort
          echo
          test -f dist/feed/feed.xml || (echo "ERROR: dist/feed/feed.xml puuttuu" && exit 1)

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
``
