name: CI/CD (multi-item RSS under /feed/feed.xml, no repo writes)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      OWNER: ${{ github.repository_owner }}   # esim. jaricgi
      REPO:  ${{ github.repository }}         # esim. JariCgi/cicdteams
      SHA:   ${{ github.sha }}
      ACTOR: ${{ github.actor }}
      COMMIT_MSG: ${{ github.event.head_commit.message || 'Automated deploy' }}
      KEEP_COUNT: "10"                        # montako viimeistä itemiä pidetään feedissä

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build site (index.html)
        shell: bash
        run: |
          set -euo pipefail
          REPO_NAME="${REPO#*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO_NAME}/"
          mkdir -p dist
          cat > dist/index.html <<'HTML'
          <!doctype html>
          <html lang="fi">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width,initial-scale=1" />
              <title>CI/CD demo</title>
              <style>
                body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:2rem;line-height:1.5}
                code{background:#f4f4f4;padding:.2rem .4rem;border-radius:.25rem}
                a{color:#0366d6;text-decoration:none}
                a:hover{text-decoration:underline}
              </style>
            </head>
            <body>
              <h1>CI/CD demo</h1>
              <p><strong>Päivitetty:</strong> __DATE__</p>
              <p>RSS: <a href="./feed/feed.xml">./feed/feed.xml</a></p>
            </body>
          </html>
          HTML
          sed -i "s|__DATE__|$(date -u)|" dist/index.html

      - name: Generate multi-item RSS (/feed/feed.xml) by merging current feed
        shell: bash
        run: |
          set -euo pipefail
          REPO_NAME="${REPO#*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO_NAME}/"
          mkdir -p dist/feed

          # Kirjoita Python-skripti tiedostoon ja aja se
          cat > gen_feed.py << 'PY'
          import os, urllib.request, xml.etree.ElementTree as ET
          from xml.dom import minidom
          from datetime import datetime, timezone
          import email.utils

          owner = os.environ["OWNER"]
          repo_full = os.environ["REPO"]
          repo = repo_full.split("/", 1)[1]
          base = f"https://{owner}.github.io/{repo}/"
          keep = int(os.environ.get("KEEP_COUNT", "10"))
          sha  = os.environ.get("SHA", "")
          actor = os.environ.get("ACTOR", "")
          commit_msg = os.environ.get("COMMIT_MSG", "Automated deploy")

          now = datetime.now(timezone.utc)
          pub_date = email.utils.format_datetime(now, usegmt=True)
          guid_val = f"{sha}--{int(now.timestamp())}"

          def el(tag, text=None, attrib=None):
              e = ET.Element(tag, attrib or {})
              if text is not None:
                  e.text = text
              return e

          # Uusi item
          new_item = el("item")
          new_item.append(el("title", commit_msg))
          new_item.append(el("description", f"Deploy by {actor}"))
          new_item.append(el("pubDate", pub_date))
          new_item.append(el("guid", guid_val, {"isPermaLink": "false"}))
          new_item.append(el("link", base))

          # Hae nykyinen feed (voi puuttua ekalla ajolla)
          existing_items = []
          url = base + "feed/feed.xml"
          try:
              with urllib.request.urlopen(url, timeout=10) as resp:
                  if resp.status == 200:
                      data = resp.read()
                      root = ET.fromstring(data)
                      channel = root.find("channel") or root.find("{*}channel")
                      if channel is not None:
                          for it in channel.findall("item"):
                              existing_items.append(it)
          except Exception:
              pass  # ei haittaa jos ei ole vielä julkaistu

          # Rakenna uusi feed
          rss = el("rss", {"version": "2.0"})
          channel = el("channel"); rss.append(channel)
          channel.append(el("title", f"{owner}/{repo} – CI/CD Demo Feed"))
          channel.append(el("link", base))
          channel.append(el("description", "Automated RSS from GitHub Actions deploys"))
          channel.append(el("lastBuildDate", pub_date))

          # Lisää uusi item ensin, sitten aiemmat (uniikit guidit), trimmaten keep-määrään
          def guid_of(item):
              g = item.find("guid")
              return g.text.strip() if g is not None and g.text else None

          seen = set()
          def add_item(it):
              g = guid_of(it)
              if g and g not in seen:
                  channel.append(it)
                  seen.add(g)

          add_item(new_item)
          for it in existing_items:
              if len(seen) >= keep:
                  break
              add_item(it)

          # Pretty print ja talletus
          xml_bytes = minidom.parseString(ET.tostring(rss, encoding="utf-8")).toprettyxml(indent="  ", encoding="utf-8")
          out_path = "dist/feed/feed.xml"
          os.makedirs(os.path.dirname(out_path), exist_ok=True)
          with open(out_path, "wb") as f:
              f.write(xml_bytes)
          print(f"Wrote feed to {out_path} with {len(seen)} item(s) (keep={keep})")
          PY

          python3 gen_feed.py

      - name: Verify files before deploy
        shell: bash
        run: |
          set -e
          echo "Files to publish:" && find dist -maxdepth 3 -type f -print | sort
          test -f dist/feed/feed.xml || (echo "❌ dist/feed/feed.xml puuttuu" && exit 1)
          echo "✅ feed löytyy"

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
