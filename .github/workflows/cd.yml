name: CD (Pages deploy, separate feed)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-cd"
  cancel-in-progress: true

jobs:
  build-and-deploy-cd:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Simuloitu deploy (korvaa omilla komennoilla) ---
      - name: Deploy (noop)
        run: |
          echo "Deploying..."
          # exit 1  # testaa failurea poistamalla kommentti
          sleep 1

      # --- Generoi CD-RSS public/feed/cd.xml ---
      - name: Generate CD RSS
        if: always()
        run: |
          mkdir -p public/feed
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S GMT")
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            TITLE="ðŸš€ CD: deploy onnistui"
            DESC="Repository: ${{ github.repository }}%0ARef: ${{ github.ref }}%0ACommit: ${{ github.sha }}%0ARun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          elif [ "$STATUS" = "cancelled" ]; then
            TITLE="â¸ï¸ CD: deploy peruttu"
            DESC="Repository: ${{ github.repository }}%0ARef: ${{ github.ref }}%0ARun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            TITLE="ðŸ”¥ CD: deploy epÃ¤onnistui"
            DESC="Repository: ${{ github.repository }}%0ARef: ${{ github.ref }}%0ACommit: ${{ github.sha }}%0ARun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          cat > public/feed/cd.xml <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <rss version="2.0">
            <channel>
              <title>CD Notifications</title>
              <link>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/</link>
              <description>CD status feed</description>
              <item>
                <title>$TITLE</title>
                <description>$DESC</description>
                <pubDate>$DATE</pubDate>
                <guid isPermaLink="false">${{ github.run_id }}-cd</guid>
                <link>https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}</link>
              </item>
            </channel>
          </rss>
          EOF

      - name: Upload Pages artifact (CD)
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages (CD)
        id: deploy
        uses: actions/deploy-pages@v4
