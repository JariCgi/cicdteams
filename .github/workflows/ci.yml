name: CI → RSS (single feed)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-single-feed"
  cancel-in-progress: true

jobs:
  ci_to_rss:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Simuloi build/test tarvittaessa)
      - name: Build & Test (noop)
        run: |
          echo "Build & tests..."
          # exit 1  # poista kommentti testataksesi failurea
          sleep 1

      # --- GENEROI/APPEND RSS feediin yhden <item>:n CI-statuksella ---
      - name: Generate/Append feed.xml (CI)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p public/feed

          FEED_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/feed/feed.xml"
          LOCAL_FEED="public/feed/feed.xml"

          # Lataa olemassa oleva feed, jos löytyy (ei virhettä jos 404)
          if curl -fsS "$FEED_URL" -o "$LOCAL_FEED.old" ; then
            echo "Existing feed downloaded."
          else
            echo "No existing feed found; creating new."
            cat > "$LOCAL_FEED.old" <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
  <channel>
    <title>CI/CD Notifications</title>
    <link></link>
    <description>CI/CD status feed (single)</description>
  </channel>
</rss>
EOF
          fi

          DATE="$(date -u +"%a, %d %b %Y %H:%M:%S GMT")"
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            TITLE="✅ CI: build & test onnistui"
            DESC="Repo: ${{ github.repository }}%0ARef: ${{ github.ref }}%0ACommit: ${{ github.sha }}%0ARun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          elif [ "$STATUS" = "cancelled" ]; then
            TITLE="⏸️ CI: peruttu"
            DESC="Repo: ${{ github.repository }}%0ARef: ${{ github.ref }}%0ARun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            TITLE="❌ CI: build/test epäonnistui"
            DESC="Repo: ${{ github.repository }}%0ARef: ${{ github.ref }}%0ACommit: ${{ github.sha }}%0ARun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          # Uusi item (lisätään listan alkuun)
          NEW_ITEM=$(cat <<EOF
    <item>
      <title>$TITLE</title>
      <description>$DESC</description>
      <pubDate>$DATE</pubDate>
      <guid isPermaLink="false">${{ github.run_id }}-ci</guid>
      <link>https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}</link>
      <category>CI</category>
    </item>
EOF
          )

          # Rakenna uusi feed:
          # - kopioi header (rss/channel alku)
          # - upota NEW_ITEM
          # - kopioi olemassa olevat itemit (max 19 kpl)
          # - sulje channel/rss
          awk -v newitem="$NEW_ITEM" '
            BEGIN{printHeader=1; itemCount=0}
            /<channel>/ {print; next}
            printHeader && /<description>/ {
              print;
              # Aseta <link> kanavatasolle
